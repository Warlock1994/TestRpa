import{h as i,j as e}from"./codemirror-core-vkcnXJgD.js";import{k as W,b as $,S as G,v as Q,x as X,y as Y,z as ee,A as se,B as te,P as ae}from"./index-DUXV0WOB.js";import{u as ne,c as D,J as d}from"./react-dom-Cz0lLOn1.js";import{a as re}from"./index-j3cnden5.js";import{e as le}from"./index-CJT7zyU5.js";import{a as ce}from"./chunk-SXMLSBOY-BHZIFoa6.js";import{a as oe,c as ie}from"./chunk-5PILOUBS-DKq7N4P3.js";import{c as de}from"./chunk-TE6SZS6W-BJLgUfXq.js";import{c as B}from"./chunk-NAV3ZXLI-DPbBQfAo.js";import{s as H}from"./chunk-J6JGI6RM-B4SU0inc.js";import{t as L}from"./chunk-6LIX6LVT-RWsS4VS1.js";import{m as ue,l as fe}from"./index-CZf4TRP1.js";import{P as z}from"./plugin_manager-HqUDCOGt.js";import{u as he}from"./use-dialog-D7Y1pqBM.js";import{i as O}from"./chunk-2QAN2V2R-Ckf_3FbK.js";import{s as V,l as J}from"./chunk-KVDW62ZT-Bm1t8H6j.js";import"./iconBase-DqQMrcxU.js";import"./index-NtwG3Lfg.js";import"./chunk-M3MASYO7-Cm5fw87L.js";import"./chunk-EN4B57RQ-DnfPgIbT.js";import"./chunk-UX7UMZL5-7aEsUCpo.js";import"./chunk-WQVQ7P2I-DnA4mjrx.js";import"./chunk-SLABUSGS-DYDfi-dm.js";import"./Item-CdZrGEbe.js";import"./chunk-AXSF7SRE-C5Cxy5n6.js";function me(a,o){if(o)try{const l=o.replace(/^git\+/,"").replace(/\.git$/,""),f=new URL(l);if(f.hostname==="github.com"||f.hostname==="www.github.com"){const u=f.pathname.split("/").filter(Boolean);if(u.length>=1)return`https://github.com/${u[0]}.png`}}catch{}if(a)try{const l=new URL(a);if(l.hostname==="github.com"||l.hostname==="www.github.com"){const f=l.pathname.split("/").filter(Boolean);if(f.length>=1)return`https://github.com/${f[0]}.png`}else return`https://api.iowen.cn/favicon/${l.hostname}.png`}catch{}}const xe=({data:a,onToggleStatus:o,onUninstall:l,onConfig:f,hasConfig:u=!1})=>{const{name:x,version:h,author:p,description:N,status:C,homepage:I,repository:M}=a,P=C==="active",[j,_]=i.useState(!1),[k,R]=i.useState(!1),[w]=ne(W.backgroundImage,""),U=!!w,n=me(I,M)||`https://avatar.vercel.sh/${encodeURIComponent(x)}`,g=()=>{_(!0),o().finally(()=>_(!1))},b=()=>{_(!0),l().finally(()=>_(!1))};return e.jsxs(oe,{className:D("group w-full backdrop-blur-md rounded-2xl overflow-hidden transition-all duration-300","hover:shadow-xl hover:-translate-y-1","border border-white/50 dark:border-white/10 hover:border-primary/50 dark:hover:border-primary/50",U?"bg-white/20 dark:bg-black/10":"bg-white/60 dark:bg-black/30"),shadow:"sm",children:[e.jsxs(ie,{className:"p-4 flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx(ce,{src:n,name:p||"?",className:"flex-shrink-0",size:"md",isBordered:!0,radius:"full",color:"default"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"text-base font-bold text-default-900 truncate",title:x,children:x}),e.jsxs("p",{className:"text-xs text-default-500 mt-0.5 truncate",children:["by ",e.jsx("span",{className:"font-medium",children:p||"æœªçŸ¥"})]})]})]}),e.jsx(B,{size:"sm",variant:"flat",color:C==="active"?"success":C==="stopped"?"warning":"default",className:"flex-shrink-0 font-medium h-6 px-1",children:C==="active"?"è¿è¡Œä¸­":C==="stopped"?"å·²åœæ­¢":"å·²ç¦ç”¨"})]}),e.jsx("div",{className:"relative min-h-[2.5rem] cursor-pointer group/desc",onClick:()=>R(!k),children:e.jsx(L,{content:N,isDisabled:!N||N.length<50||k,placement:"bottom",className:"max-w-[280px]",delay:500,children:e.jsx("p",{className:D("text-sm text-default-600 dark:text-default-400 leading-relaxed transition-all duration-300",k?"line-clamp-none":"line-clamp-2"),children:N||"æš‚æ— æè¿°"})})}),e.jsx("div",{children:e.jsxs(B,{size:"sm",variant:"flat",color:"primary",className:"h-5 text-xs font-semibold px-0.5",classNames:{content:"px-1"},children:["v",h]})})]}),e.jsxs(de,{className:"px-4 pb-4 pt-0 gap-3",children:[e.jsx(H,{isDisabled:j,isSelected:P,onValueChange:g,size:"sm",color:"success",classNames:{wrapper:"group-data-[selected=true]:bg-success"},children:e.jsx("span",{className:"text-xs font-medium text-default-600",children:P?"å·²å¯ç”¨":"å·²ç¦ç”¨"})}),e.jsx("div",{className:"flex-1"}),u&&e.jsx(L,{content:"æ’ä»¶é…ç½®",children:e.jsx($,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",color:"primary",onPress:f,children:e.jsx(ue,{size:20})})}),e.jsx(L,{content:"å¸è½½æ’ä»¶",color:"danger",children:e.jsx($,{isIconOnly:!0,radius:"full",size:"sm",variant:"light",color:"danger",onPress:b,isDisabled:j,children:e.jsx(fe,{size:20})})})]})]})};function K(a,o=60){if(a.length<=o)return a;const l=a.includes("\\")?"\\":"/",f=a.split(l);if(f.length<=3)return a.substring(0,o-3)+"...";const u=f[0],x=f.slice(-2).join(l),h=`${u}${l}...${l}${x}`;return h.length>o?a.substring(0,o-3)+"...":h}function pe(a,o=100){if(a.length<=o)return a;const l=/[A-Za-z]:\\[^\s'"]+/g,f=/\/[^\s'"]+(?:\/[^\s'"]+)+/g;let u=a;const x=a.match(l);if(x)for(const p of x)p.length>40&&(u=u.replace(p,K(p,40)));const h=a.match(f);if(h)for(const p of h)p.length>40&&(u=u.replace(p,K(p,40)));return u.length>o?u.substring(0,o-3)+"...":u}const T={error:(a,o)=>{const l=typeof a=="string"?pe(a):a;return d.error(l,o)},success:(a,o)=>d.success(a,o),loading:(a,o)=>d.loading(a,o),custom:d.custom,dismiss:d.dismiss,remove:d.remove,promise:d.promise};function ge({isOpen:a,onOpenChange:o,pluginId:l}){const[f,u]=i.useState(!1),[x,h]=i.useState([]),[p,N]=i.useState({}),[C,I]=i.useState(!1),[M,P]=i.useState(!1),[j,_]=i.useState(null),[k,R]=i.useState(!1),w=i.useRef(null),U=i.useRef({});i.useEffect(()=>{U.current=p},[p]);const n=i.useCallback(s=>{switch(s.type){case"full":s.schema&&h(s.schema);break;case"updateField":s.key&&s.field&&h(c=>c.map(t=>t.key===s.key?{...t,...s.field}:t));break;case"removeField":s.key&&h(c=>c.filter(t=>t.key!==s.key));break;case"addField":s.field&&h(c=>{const t=s.field,y=c.findIndex(r=>r.key===t.key);if(y!==-1){const r=[...c];return r[y]={...r[y],...t},r}if(s.afterKey){const r=c.findIndex(m=>m.key===s.afterKey);if(r!==-1){const m=[...c];return m.splice(r+1,0,t),m}}return[...c,t]});break;case"showField":s.key&&h(c=>c.map(t=>t.key===s.key?{...t,hidden:!1}:t));break;case"hideField":s.key&&h(c=>c.map(t=>t.key===s.key?{...t,hidden:!0}:t));break}},[]),g=i.useCallback(s=>{w.current&&w.current.close();const c=localStorage.getItem(W.token);if(!c){console.warn("æœªç™»å½•ï¼Œæ— æ³•å»ºç«‹ SSE è¿æ¥");return}const t=JSON.parse(c),y=z.getConfigSSEUrl(l,s),r=new G.EventSourcePolyfill(y,{headers:{Authorization:`Bearer ${t}`,Accept:"text/event-stream"},withCredentials:!0});w.current=r,r.addEventListener("connected",m=>{const v=JSON.parse(m.data);_(v.sessionId),R(!0)}),r.addEventListener("schema",m=>{const v=JSON.parse(m.data);n(v)}),r.addEventListener("error",m=>{try{const v=JSON.parse(m.data);T.error("æ’ä»¶é”™è¯¯: "+v.message)}catch{R(!1)}}),r.onerror=()=>{R(!1)}},[l,n]),b=i.useCallback(()=>{w.current&&(w.current.close(),w.current=null),_(null),R(!1)},[]);i.useEffect(()=>(a&&l&&E(),()=>{b()}),[a,l,b]);const E=async()=>{u(!0),h([]),N({}),P(!1),b();try{const s=await z.getPluginConfig(l);h(s.schema||[]),N(s.config||{}),P(!!s.supportReactive),s.supportReactive&&g(s.config||{})}catch(s){T.error("åŠ è½½é…ç½®å¤±è´¥: "+s.message)}finally{u(!1)}},S=async()=>{I(!0);try{await z.setPluginConfig(l,p),T.success("Configuration saved"),o()}catch(s){T.error("Save failed: "+s.message)}finally{I(!1)}},F=i.useCallback((s,c)=>{N(t=>{const y={...t,[s]:c},r=x.find(m=>m.key===s);return r!=null&&r.reactive&&j&&k&&z.notifyConfigChange(l,j,s,c,y).catch(m=>console.error("é€šçŸ¥é…ç½®å˜åŒ–å¤±è´¥:",m)),y})},[x,j,k,l]),Z=s=>{const c=p[s.key]??s.default;switch(s.type){case"string":return e.jsx(O,{label:s.label,placeholder:s.placeholder||s.description,value:c||"",onValueChange:t=>F(s.key,t),description:s.description,className:"mb-4"},s.key);case"number":return e.jsx(O,{type:"number",label:s.label,placeholder:s.placeholder||s.description,value:String(c??0),onValueChange:t=>F(s.key,Number(t)),description:s.description,className:"mb-4"},s.key);case"boolean":return e.jsxs("div",{className:"flex justify-between items-center mb-4 p-2 bg-default-100 rounded-lg",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-small",children:s.label}),s.description&&e.jsx("span",{className:"text-tiny text-default-500",children:s.description})]}),e.jsx(H,{isSelected:!!c,onValueChange:t=>F(s.key,t)})]},s.key);case"select":{const t=c!==void 0?String(c):void 0,y=s.options||[];return e.jsx(V,{label:s.label,placeholder:s.placeholder||"Select an option",selectedKeys:t?[t]:[],onSelectionChange:r=>{const m=Array.from(r)[0],v=y.find(A=>String(A.value)===m);F(s.key,v?v.value:m)},description:s.description,className:"mb-4",children:y.map(r=>e.jsx(J,{textValue:r.label,children:r.label},String(r.value)))},s.key)}case"multi-select":{const t=Array.isArray(c)?c.map(String):[],y=s.options||[];return e.jsx(V,{label:s.label,placeholder:s.placeholder||"Select options",selectionMode:"multiple",selectedKeys:new Set(t),onSelectionChange:r=>{const m=Array.from(r).map(v=>{const A=y.find(q=>String(q.value)===v);return A?A.value:v});F(s.key,m)},description:s.description,className:"mb-4",children:y.map(r=>e.jsx(J,{textValue:r.label,children:r.label},String(r.value)))},s.key)}case"html":return e.jsxs("div",{className:"mb-4",children:[s.label&&e.jsx("h4",{className:"text-small font-bold mb-1",children:s.label}),e.jsx("div",{dangerouslySetInnerHTML:{__html:s.default||""},className:"prose dark:prose-invert max-w-none"}),s.description&&e.jsx("p",{className:"text-tiny text-default-500 mt-1",children:s.description})]},s.key);case"text":return e.jsxs("div",{className:"mb-4",children:[s.label&&e.jsx("h4",{className:"text-small font-bold mb-1",children:s.label}),e.jsx("div",{className:"whitespace-pre-wrap text-default-700",children:s.default||""}),s.description&&e.jsx("p",{className:"text-tiny text-default-500 mt-1",children:s.description})]},s.key);default:return null}};return e.jsx(Q,{isOpen:a,onOpenChange:o,size:"2xl",scrollBehavior:"inside",children:e.jsx(X,{children:s=>e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"flex flex-col gap-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:["æ’ä»¶é…ç½®: ",l,M&&e.jsx("span",{className:`text-tiny px-2 py-0.5 rounded ${k?"bg-success-100 text-success-600":"bg-warning-100 text-warning-600"}`,children:k?"å·²è¿æ¥":"æœªè¿æ¥"})]})}),e.jsx(ee,{children:f?e.jsx("div",{className:"flex justify-center p-8",children:"Loading configuration..."}):e.jsx("div",{className:"flex flex-col gap-2",children:x.length===0?e.jsx("div",{className:"text-center text-default-500",children:"No configuration schema available."}):x.filter(c=>!c.hidden).map(Z)})}),e.jsxs(se,{children:[e.jsx($,{color:"danger",variant:"light",onPress:s,children:"Close"}),e.jsx($,{color:"primary",onPress:S,isLoading:C,children:"Save"})]})]})})})}function Ve(){const[a,o]=i.useState([]),[l,f]=i.useState(!1),[u,x]=i.useState(!1),h=he(),{isOpen:p,onOpen:N,onOpenChange:C}=te(),[I,M]=i.useState(""),P=i.useRef(null),j=async()=>{f(!0),x(!1);try{const n=await z.getPluginList();n.pluginManagerNotFound?(x(!0),o([])):o(n.plugins)}catch(n){d.error(n.message)}finally{f(!1)}};i.useEffect(()=>{j()},[]);const _=async n=>{const g=n.status!=="active",b=g?"å¯ç”¨":"ç¦ç”¨",E=d.loading(`${b}ä¸­...`);try{await z.setPluginStatus(n.id,g),d.success(`${b}æˆåŠŸ`,{id:E}),j()}catch(S){d.error(S.message,{id:E})}},k=async n=>new Promise((g,b)=>{h.confirm({title:"å¸è½½æ’ä»¶",content:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("p",{children:["ç¡®å®šè¦å¸è½½æ’ä»¶ã€Œ",n.name,"ã€å—? æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚"]}),e.jsx("p",{className:"text-small text-default-500",children:"å¦‚æœæ’ä»¶åˆ›å»ºäº†æ•°æ®æ–‡ä»¶ï¼Œæ˜¯å¦ä¸€å¹¶åˆ é™¤ï¼Ÿ"})]}),onConfirm:async()=>{const E=window.confirm(`æ˜¯å¦åŒæ—¶æ¸…ç†æ’ä»¶ã€Œ${n.name}ã€çš„æ•°æ®æ–‡ä»¶ï¼Ÿ
ç‚¹å‡»â€œç¡®å®šâ€æ¸…ç†æ•°æ®ï¼Œç‚¹å‡»â€œå–æ¶ˆâ€ä»…å¸è½½æ’ä»¶ã€‚`),S=d.loading("å¸è½½ä¸­...");try{await z.uninstallPlugin(n.id,E),d.success("å¸è½½æˆåŠŸ",{id:S}),j(),g()}catch(F){d.error(F.message,{id:S}),b(F)}},onCancel:()=>{g()}})}),R=n=>{M(n.id),N()},w=()=>{var n;if(u){h.confirm({title:"æ’ä»¶ç®¡ç†å™¨æœªåŠ è½½",content:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-default-600",children:"æ’ä»¶ç®¡ç†å™¨å°šæœªåŠ è½½ï¼Œæ— æ³•å¯¼å…¥æ’ä»¶ã€‚"}),e.jsx("p",{className:"text-sm text-default-600",children:"æ˜¯å¦ç«‹å³æ³¨å†Œæ’ä»¶ç®¡ç†å™¨ï¼Ÿ"})]}),confirmText:"æ³¨å†Œæ’ä»¶ç®¡ç†å™¨",cancelText:"å–æ¶ˆ",onConfirm:async()=>{var g;try{await z.registerPluginManager(),d.success("æ’ä»¶ç®¡ç†å™¨æ³¨å†ŒæˆåŠŸ"),x(!1),(g=P.current)==null||g.click()}catch(b){d.error("æ³¨å†Œå¤±è´¥: "+b.message)}}});return}(n=P.current)==null||n.click()},U=async n=>{var E;const g=(E=n.target.files)==null?void 0:E[0];if(!g)return;if(n.target.value="",!g.name.endsWith(".zip")){d.error("è¯·é€‰æ‹© .zip æ ¼å¼çš„æ’ä»¶åŒ…");return}const b=d.loading("æ­£åœ¨å¯¼å…¥æ’ä»¶...");try{const S=await z.importLocalPlugin(g);d.success(S.message,{id:b}),j()}catch(S){d.error(S.message||"å¯¼å…¥å¤±è´¥",{id:b})}};return e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"æ’ä»¶ç®¡ç† - NapCat WebUI"}),e.jsxs("div",{className:"p-2 md:p-4 relative",children:[e.jsx(ae,{loading:l}),e.jsx(ge,{isOpen:p,onOpenChange:C,pluginId:I}),e.jsxs("div",{className:"flex mb-6 items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"æ’ä»¶ç®¡ç†"}),e.jsx($,{isIconOnly:!0,className:"bg-default-100/50 hover:bg-default-200/50 text-default-700 backdrop-blur-md",radius:"full",onPress:j,children:e.jsx(re,{size:24})}),e.jsx($,{className:"bg-primary-100/50 hover:bg-primary-200/50 text-primary-700 backdrop-blur-md",radius:"full",startContent:e.jsx(le,{size:18}),onPress:w,children:"å¯¼å…¥æ’ä»¶"}),e.jsx("input",{ref:P,type:"file",accept:".zip",className:"hidden",onChange:U})]}),u?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px] text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"ğŸ“¦"}),e.jsx("h2",{className:"text-xl font-semibold text-default-700 dark:text-white/90 mb-2",children:"æ— æ’ä»¶åŠ è½½"}),e.jsx("p",{className:"text-default-500 dark:text-white/60 max-w-md",children:"æ’ä»¶ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ plugins ç›®å½•æ˜¯å¦å­˜åœ¨"})]}):a.length===0?e.jsx("div",{className:"text-default-400",children:"æš‚æ—¶æ²¡æœ‰å®‰è£…æ’ä»¶"}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 justify-start items-stretch gap-x-2 gap-y-4",children:a.map(n=>e.jsx(xe,{data:n,onToggleStatus:()=>_(n),onUninstall:()=>k(n),onConfig:()=>{n.status!=="active"?d.error("æœªå¯ç”¨æ’ä»¶ï¼Œæ— æ³•é…ç½®æ’ä»¶"):n.hasConfig?R(n):d.error("æ­¤æ’ä»¶æ²¡æœ‰é…ç½®å“¦")},hasConfig:!0},n.id))})]})]})}export{Ve as default};
